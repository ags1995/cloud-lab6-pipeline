terraform {
  required_version = ">= 1.0.0"
  required_providers {
    openstack = {
      source  = "terraform-provider-openstack/openstack"
      version = "~> 1.48.0"
    }
  }
}

# Configure OpenStack provider
provider "openstack" {
  auth_url    = "https://cloud.crplab.ru:5000/v3"
  region      = "RegionOne"
  user_name   = "master2022"
  password    = "J8F3LGa*7KU7ye"
  tenant_name = "students"
  domain_name = "Default"
}

# Create a keypair
resource "openstack_compute_keypair_v2" "lab5_keypair" {
  name       = "lab5-terraform-key"
  public_key = file("~/.ssh/id_rsa.pub")
}

# Create a security group
resource "openstack_networking_secgroup_v2" "lab5_secgroup" {
  name        = "lab5-security-group"
  description = "Security group for Lab 5 Terraform"
}

# Security group rules
resource "openstack_networking_secgroup_rule_v2" "ssh" {
  direction         = "ingress"
  ethertype         = "IPv4"
  protocol          = "tcp"
  port_range_min    = 22
  port_range_max    = 22
  remote_ip_prefix  = "0.0.0.0/0"
  security_group_id = openstack_networking_secgroup_v2.lab5_secgroup.id
}

resource "openstack_networking_secgroup_rule_v2" "http" {
  direction         = "ingress"
  ethertype         = "IPv4"
  protocol          = "tcp"
  port_range_min    = 80
  port_range_max    = 80
  remote_ip_prefix  = "0.0.0.0/0"
  security_group_id = openstack_networking_secgroup_v2.lab5_secgroup.id
}

resource "openstack_networking_secgroup_rule_v2" "https" {
  direction         = "ingress"
  ethertype         = "IPv4"
  protocol          = "tcp"
  port_range_min    = 443
  port_range_max    = 443
  remote_ip_prefix  = "0.0.0.0/0"
  security_group_id = openstack_networking_secgroup_v2.lab5_secgroup.id
}

resource "openstack_networking_secgroup_rule_v2" "icmp" {
  direction         = "ingress"
  ethertype         = "IPv4"
  protocol          = "icmp"
  remote_ip_prefix  = "0.0.0.0/0"
  security_group_id = openstack_networking_secgroup_v2.lab5_secgroup.id
}

# Get network data
data "openstack_networking_network_v2" "students_net" {
  name = "sutdents-net"
}

data "openstack_images_image_v2" "ubuntu" {
  name        = "ubuntu-20.04"
  most_recent = true
}

data "openstack_compute_flavor_v2" "small" {
  name = "m1.small"
}

# Create server instance
resource "openstack_compute_instance_v2" "lab5_server" {
  name            = "lab5-terraform-vm"
  image_id        = data.openstack_images_image_v2.ubuntu.id
  flavor_id       = data.openstack_compute_flavor_v2.small.id
  key_pair        = openstack_compute_keypair_v2.lab5_keypair.name
  security_groups = [openstack_networking_secgroup_v2.lab5_secgroup.name]

  network {
    name = data.openstack_networking_network_v2.students_net.name
  }

  depends_on = [
    openstack_compute_keypair_v2.lab5_keypair,
    openstack_networking_secgroup_v2.lab5_secgroup
  ]
}

# Get floating IP
resource "openstack_networking_floatingip_v2" "floating_ip" {
  pool = "ext-net"
}

# Associate floating IP with instance
resource "openstack_compute_floatingip_associate_v2" "fip_assoc" {
  floating_ip = openstack_networking_floatingip_v2.floating_ip.address
  instance_id = openstack_compute_instance_v2.lab5_server.id
}

# Outputs
output "instance_ip" {
  value = openstack_compute_instance_v2.lab5_server.access_ip_v4
}

output "floating_ip" {
  value = openstack_networking_floatingip_v2.floating_ip.address
}

output "ssh_command" {
  value = "ssh -i ~/.ssh/id_rsa ubuntu@${openstack_networking_floatingip_v2.floating_ip.address}"
}
